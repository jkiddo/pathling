"use strict";(self.webpackChunkpathling_site=self.webpackChunkpathling_site||[]).push([[540],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),d=r,h=c["".concat(s,".").concat(d)]||c[d]||m[d]||i;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6443:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const i={description:"A set of functions written in TypeScript that facilitate the export of resources from a FHIR server and import into Pathling, via a staging S3 bucket. They can also be used as AWS Lambda functions."},o="pathling-import",l={unversionedId:"libraries/javascript/pathling-import",id:"libraries/javascript/pathling-import",title:"pathling-import",description:"A set of functions written in TypeScript that facilitate the export of resources from a FHIR server and import into Pathling, via a staging S3 bucket. They can also be used as AWS Lambda functions.",source:"@site/docs/libraries/javascript/pathling-import.md",sourceDirName:"libraries/javascript",slug:"/libraries/javascript/pathling-import",permalink:"/docs/libraries/javascript/pathling-import",draft:!1,editUrl:"https://github.com/aehrc/pathling/tree/main/site/docs/libraries/javascript/pathling-import.md",tags:[],version:"current",frontMatter:{description:"A set of functions written in TypeScript that facilitate the export of resources from a FHIR server and import into Pathling, via a staging S3 bucket. They can also be used as AWS Lambda functions."},sidebar:"libraries",previous:{title:"pathling-client",permalink:"/docs/libraries/javascript/pathling-client"}},s={},p=[{value:"Use with AWS Lambda",id:"use-with-aws-lambda",level:2},{value:"fhirExport",id:"fhirexport",level:3},{value:"checkExportStatus",id:"checkexportstatus",level:3},{value:"transferToS3",id:"transfertos3",level:3},{value:"pathlingImport",id:"pathlingimport",level:3},{value:"AWS Step Functions",id:"aws-step-functions",level:3},{value:"Sentry support",id:"sentry-support",level:3},{value:"Use as a Node.js command-line program",id:"use-as-a-nodejs-command-line-program",level:2},{value:"Important notes",id:"important-notes",level:2}],u={toc:p},c="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"pathling-import"},"pathling-import"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/pathling-import"},"pathling-import")," is a set of\nfunctions written in TypeScript that facilitate the export of resources from a\nFHIR server and import into Pathling, via a staging S3 bucket. They can also be\nused as AWS Lambda functions."),(0,r.kt)("h2",{id:"use-with-aws-lambda"},"Use with AWS Lambda"),(0,r.kt)("p",null,"This package includes a module named ",(0,r.kt)("inlineCode",{parentName:"p"},"handlers")," which exports the functions\ndescribed below. AWS Lambda functions are configured using environment\nvariables - the supported variables are described for each function."),(0,r.kt)("h3",{id:"fhirexport"},"fhirExport"),(0,r.kt)("p",null,"Kicks off a bulk export operation at a FHIR endpoint."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Input:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"[none]")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Output:")," ",(0,r.kt)("inlineCode",{parentName:"p"},'{ "statusUrl": [string] }')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Configuration:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_ENDPOINT"),": The base URL of the source FHIR server."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"TYPES"),": (optional) A comma-delimited set of resource types for which export\nwill be requested."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SINCE"),": A ",(0,r.kt)("a",{parentName:"li",href:"https://hl7.org/fhir/R4/datatypes.html#instant"},"FHIR instant"),"\nformatted time used to filter the results based on their last updated time."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_CLIENT_ID"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_CLIENT_SECRET"),": Client credentials for the source\ntoken grant."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_SCOPES"),": Scopes to request as part of the source token grant.")),(0,r.kt)("h3",{id:"checkexportstatus"},"checkExportStatus"),(0,r.kt)("p",null,"Gets the result of a FHIR bulk export operation."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Input:")," ",(0,r.kt)("inlineCode",{parentName:"p"},'{ "statusUrl": [string] }')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Output:")," ",(0,r.kt)("inlineCode",{parentName:"p"},'{ "result": [FHIR bulk export result] }'),", or a ",(0,r.kt)("inlineCode",{parentName:"p"},"JobInProgressError"),"\nthrown"),(0,r.kt)("p",null,"Configuration:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_ENDPOINT"),": The base URL of the source FHIR server."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_CLIENT_ID"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_CLIENT_SECRET"),": Client credentials for the source\ntoken grant."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_SCOPES"),": Scopes to request as part of the source token grant.")),(0,r.kt)("h3",{id:"transfertos3"},"transferToS3"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Input:")," ",(0,r.kt)("inlineCode",{parentName:"p"},'{ "result": [FHIR bulk export result] }')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Output:")," ",(0,r.kt)("inlineCode",{parentName:"p"},'{ "parameters": [Pathling import operation input parameters] }')),(0,r.kt)("p",null,"Downloads a FHIR bulk export and uploads it to S3."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Configuration:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_ENDPOINT"),": The base URL of the source FHIR server."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_CLIENT_ID"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_CLIENT_SECRET"),": Client credentials for the source\ntoken grant."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"SOURCE_SCOPES"),": Scopes to request as part of the source token grant."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"STAGING_URL"),": An S3 location that can be used to stage NDJSON files from the\nsource ahead of import to Pathling.")),(0,r.kt)("h3",{id:"pathlingimport"},"pathlingImport"),(0,r.kt)("p",null,"Kicks off a Pathling import operation."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Input:")," ",(0,r.kt)("inlineCode",{parentName:"p"},'{ "parameters": [Pathling import operation input parameters] }')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Output:")," ",(0,r.kt)("inlineCode",{parentName:"p"},'{ "statusUrl": [string] }')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Configuration:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"TARGET_ENDPOINT"),": The base URL of the target Pathling server."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"TARGET_CLIENT_ID"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"TARGET_CLIENT_SECRET"),": Client credentials for the target\ntoken grant."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"TARGET_SCOPES"),": (optional, defaults to ",(0,r.kt)("inlineCode",{parentName:"li"},"user/*.write"),") Scopes to request as\npart of the target token grant.")),(0,r.kt)("h3",{id:"aws-step-functions"},"AWS Step Functions"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/step-functions/latest/dg/welcome.html"},"AWS Step Functions"),"\nis an orchestration service that provides a convenient way of running the Lambda\nfunctions that you create using the handlers."),(0,r.kt)("p",null,"Here is an example of some Amazon States Language configuration that can run\nthese functions to keep a FHIR endpoint in sync with Pathling:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "Comment": "A workflow that exports data from a FHIR server, stages it on S3 and imports it into a Pathling instance",\n  "StartAt": "FHIR export",\n  "States": {\n    "FHIR export": {\n      "Type": "Task",\n      "Resource": "[lambda arn]",\n      "Next": "Check export status",\n      "Retry": [\n        {\n          "ErrorEquals": [\n            "States.ALL"\n          ], "IntervalSeconds": 60, "MaxAttempts": 5\n        }\n      ]\n    }, "Check export status": {\n      "Type": "Task", "Resource": "[lambda arn]", "Retry": [\n        {\n          "ErrorEquals": [\n            "JobInProgressError"\n          ], "IntervalSeconds": 900, "MaxAttempts": 24, "BackoffRate": 1\n        }, {\n          "ErrorEquals": [\n            "States.ALL"\n          ], "IntervalSeconds": 60, "MaxAttempts": 5\n        }\n      ], "Next": "Transfer to S3"\n    }, "Transfer to S3": {\n      "Type": "Task", "Resource": "[lambda arn]", "Retry": [\n        {\n          "ErrorEquals": [\n            "States.ALL"\n          ], "IntervalSeconds": 60, "MaxAttempts": 5\n        }\n      ], "Next": "Pathling import"\n    }, "Pathling import": {\n      "Type": "Task",\n      "Resource": "[lambda arn]",\n      "Next": "Check import result",\n      "Retry": [\n        {\n          "ErrorEquals": [\n            "States.ALL"\n          ], "IntervalSeconds": 60, "MaxAttempts": 5\n        }\n      ]\n    }, "Check import result": {\n      "Type": "Choice", "Choices": [\n        {\n          "Variable": "$.statusUrl",\n          "IsNull": true,\n          "Next": "Import not necessary"\n        }\n      ], "Default": "Check import status"\n    }, "Import not necessary": {\n      "Type": "Succeed"\n    }, "Check import status": {\n      "Type": "Task", "Resource": "[lambda arn]", "Retry": [\n        {\n          "ErrorEquals": [\n            "JobInProgressError"\n          ], "IntervalSeconds": 300, "MaxAttempts": 12, "BackoffRate": 1\n        }, {\n          "ErrorEquals": [\n            "States.ALL"\n          ], "IntervalSeconds": 60, "MaxAttempts": 5\n        }\n      ], "End": true\n    }\n  }\n}\n')),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-cloudwatch-events-target.html"},"CloudWatch Events"),"\ncan be used to schedule the running of the step function at a specified\nfrequency."),(0,r.kt)("h3",{id:"sentry-support"},"Sentry support"),(0,r.kt)("p",null,"This program can also report any errors to Sentry - just set the ",(0,r.kt)("inlineCode",{parentName:"p"},"SENTRY_DSN"),",\n",(0,r.kt)("inlineCode",{parentName:"p"},"SENTRY_ENVIRONMENT")," (optional) and ",(0,r.kt)("inlineCode",{parentName:"p"},"SENTRY_RELEASE")," (optional) environment\nvariables."),(0,r.kt)("h2",{id:"use-as-a-nodejs-command-line-program"},"Use as a Node.js command-line program"),(0,r.kt)("p",null,"These functions can also be installed as an NPM package, using the following\ncommand:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"npm -g install pathling-import\n")),(0,r.kt)("p",null,"This provides the ability to run the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"pathling-import [configuration file]\n")),(0,r.kt)("p",null,"This command requires all of the environment variables described so far in this\ndocument. It will orchestrate the entire sequence of functions, including retry\nof job status checks and the S3 transfer. These additional optional variables\ncontrol the retry functionality:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"EXPORT_RETRY_TIMES"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"TRANSFER_RETRY_TIMES"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"IMPORT_RETRY_TIMES")," -\n(default: ",(0,r.kt)("inlineCode",{parentName:"li"},"24"),") The maximum number of times each operation will be retried."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"EXPORT_RETRY_WAIT"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"TRANSFER_RETRY_WAIT"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"IMPORT_RETRY_WAIT")," -\n(default: ",(0,r.kt)("inlineCode",{parentName:"li"},"900"),") The number of seconds to wait before retrying the operation."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"EXPORT_RETRY_BACK_OFF"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"TRANSFER_RETRY_BACK_OFF"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"IMPORT_RETRY_BACK_OFF")," -\n(default: ",(0,r.kt)("inlineCode",{parentName:"li"},"1.0"),") The factor by which to multiply the wait upon each retry.")),(0,r.kt)("p",null,"The configuration file argument is optional - you can configure the program\nusing either a JSON file or environment variables. If you are using a JSON file,\nthe variables translate to keys in lower camel case."),(0,r.kt)("p",null,"When running this command, you will also need to provide AWS credentials using\nany of the methods described in\n",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-credentials-node.html"},"Setting Credentials in Node.js"),"\n.\nThe AWS credentials provided will require the ",(0,r.kt)("inlineCode",{parentName:"p"},"GetObject")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"PutObject"),"\npermissions on the specified S3 location."),(0,r.kt)("h2",{id:"important-notes"},"Important notes"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"This script assumes that both source and target endpoints can be accessed\nusing an OAuth2 client credentials grant."),(0,r.kt)("li",{parentName:"ul"},"The source FHIR endpoint must provide a\n",(0,r.kt)("a",{parentName:"li",href:"https://www.hl7.org/fhir/smart-app-launch/conformance.html#using-well-known"},"SMART configuration document"),"\nfor discovery of its authentication configuration.")))}m.isMDXComponent=!0}}]);